<!DOCTYPE html>
<html lang="ko"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{cmmn/layout}">
	
<section layout:fragment="content">
	<h1>계층형 게시판</h1>
	<div class="container">
		<img src="/static/img/a482aa92-df76-418e-abfd-50794432f5f8_소소한오픈소스기여.png" />
<table class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th style="width: 7%">글번호</th>
                <th scope="col">제목</th>
                <th style="width: 7%">작성자</th>
                <th style="width: 8%">날짜</th>
            </tr>
        </thead>
        <tbody id="wrap__post">
<!--             <tr th:each="post: ${posts}">
                <td class="text-center" scope="row" data-id="${post.id}" th:text="${post.id}"></td>
                <td class="text-overflow" style="max-width: 300px;" th:text="${post.title}"></td>
                <td class="text-overflow" style="max-width: 100px;" th:text="${post.authorName}"></td>
                <td class="text-center" th:text="${post.createdDate}"></td>
            </tr> -->
        </tbody>
    </table>

<div align="right" class="col-md-12 left">
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#savePostsModal">글 등록</button>
    </div>
<div class="center-block" style="width: 300px;padding:15px;">
 <nav aria-label="Page navigation">
  <ul class="pagination">
    <li class="page-item"><a class="page-link" href="#">Previous</a></li>
    <li class="page-item"><a class="page-link" href="#">1</a></li>
    <li class="page-item"><a class="page-link" href="#">2</a></li>
    <li class="page-item"><a class="page-link" href="#">3</a></li>
    <li class="page-item"><a class="page-link" href="#">Next</a></li>
  </ul>
</nav>
</div>
</div>
    <div class="modal fade" id="savePostsModal" tabindex="-1" role="dialog" aria-labelledby="savePostsLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="savePostsLabel">게시글 등록</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form enctype="multipart/form-data" th:action="@{/post/save}" method="post" id="write-frm">
                        <div class="form-group">
                            <label for="title">제목</label>
                            <input type="text" class="form-control" name="title" id="title" placeholder="제목을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label for="author"> 이미지 </label>
                            <input type="file" class="form-control" name="images" id="images" placeholder="이미지 첨부" multiple accept="image/*">
                        </div>
                        <div class="form-group">
                            <label for="content"> 내용 </label>
                            <textarea class="form-control" name="content" id="content" placeholder="내용을 입력하세요"  style="resize: none; height: 300px;"></textarea>
                        </div>
                    </form>
                                     <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="btn-write">등록</button>
                </div>
                </div>

            </div>
        </div>
    </div>
    <script>
    	let board = {
    		init: function() {
    			this.clickWriteBtn();
    			this.cheackImageFiles();
    			this.getPosts();
    		},
    		csrf: {
    			token: $("meta[name='_csrf']").attr("content"),
    			header: $("meta[name='_csrf_header']").attr("content")
    		},
    		cheackImageFiles: function() {
    			$("#images").change(function(e) {
    				let files = this.files
    				if (files.length > 3) {
    					alert("이미지는 최대 3개까지만 가능합니다.")
    					$(this).val("")
    				}
    				
    				for(let i = 0; i < files.length; i++) {
    					if(!files[i].type.includes("image/")) {
    						alert("이미지만 등록할 수 있습니다.");
    						$(this).val("")
    					}
    				}
    			})
    		},
    		clickWriteBtn: function() {
    			let $this = this;
    			$("#btn-write").click(function() {
    				let post = new FormData($("#write-frm")[0]);
     		        $.ajax({
			            type: 'POST',
			            url: '/post/save',
			            dataType: 'json',
			            contentType: false,//'application/json; charset=utf-8',
			            processData: false,
			            enctype: 'multipart/form-data',
			            data: post,//post,//JSON.stringify(post),
			            beforeSend: function(xhr) {
		    				xhr.setRequestHeader($this.csrf.header, $this.csrf.token);
		    			}
			        }).done(function(result) {
			        	if (result.msg === "save") {
				        	alert("게시글이 등록되었습니다.");
				        	location.reload();
			        	} else {
			        		alert("게시글 등록에 실패했습니다. 다시 작성해주세요");
			        		location.reload();
			        	}
			        }).fail(function (error) {
			            console.log(error);
			        }); 
    			})
    		},
    		getPosts: function() {
    			let $this = this;
    			 $.ajax({
			            type: 'GET',
			            url: '/posts',
			            dataType: 'json',
			            contentType:'application/json; charset=utf-8',		        
			            beforeSend: function(xhr) {
		    				xhr.setRequestHeader($this.csrf.header, $this.csrf.token);
		    			}
			        }).done(function(result) {
			        	console.log(result);
			        	$("#wrap__post").empty();
			        	result.posts.forEach(post => {
			        		const hierarchicalStamp = 'ㄴ'.repeat(post.depth);
				        	const postTableTag = `
				                <tr>
				                	<td class="text-center" scope="row" data-id="${post.id}">${post.id}</td>
				                	<td class="text-overflow" style="max-width: 300px;">${hierarchicalStamp + ' ' +post.title}</td>
				                	<td class="text-center" style="max-width: 100px;">${post.authorName}</td>
				                	<td class="text-center">${post.createdDate}</td>
				            	</tr>
				        	`;
				        	$("#wrap__post").append(postTableTag);
			        	})
			        	if (result.msg !== "success") {
			        		alert("게시글 로드에 실패했습니다.");
			        		location.reload();
			        	} 
			        }).fail(function (error) {
			            console.log(error);
			        }); 
    		}
    	}
    	$(function() {
    		board.init()
/*     		$("#btn-write").click(function() {
    			$("#write-frm").submit();
    		}); */
    		$(".table tbody tr").click(function() {
    			console.log(this);
    			console.log(this.children)
    			console.log($(this).children("td").data("id"))
    			
    		})
    	})
    </script>
</section>


